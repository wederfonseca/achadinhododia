<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Achadinho do Dia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="icon" type="image/png" href="favicon-v6.png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <!-- META PIXEL (APENAS PAGEVIEW) -->
  <script>
  !function(f,b,e,v,n,t,s){
    if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)
  }(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');

  fbq('init', '777056694717675');
  fbq('track', 'PageView');
  </script>
</head>

<body>

<div class="page">
  <div class="top-bar">As melhores ofertas do dia, direto no seu WhatsApp</div>

  <div class="subtitle">
    Escolhemos diariamente o que faz sentido para vocÃª economizar.
  </div>

  <div class="image-box">
    <img src="caixa.png" alt="Ofertas">
  </div>

  <div class="urgency">âš¡ Os melhores preÃ§os acabam rÃ¡pido</div>

  <a id="joinBtn"
     class="btn"
     href="https://busqy.me/grupos/achadinhododia">
     ENTRAR NO GRUPO DE OFERTAS
  </a>

  <div class="checks">
    âœ… SÃ³ o que vale a pena<br>
    âœ… VocÃª pode sair quando quiser<br>
    âœ… PromoÃ§Ãµes exclusivas todos os dias
  </div>
</div>

<!-- OVERLAY (estÃ¡tico, sem animaÃ§Ã£o) -->
<div id="loading" class="loading hidden">
  <div class="loading-box">
    ðŸ”’ Reservando sua vaga no grupoâ€¦
  </div>
</div>

<script>
/* Tempo fixo de exibiÃ§Ã£o do loading (1 segundo) */
const WAIT_MS = 1000;
let locked = false;

function generateEventId() {
  if (crypto && crypto.randomUUID) return crypto.randomUUID();
  return 'evt_' + Date.now() + '_' + Math.floor(Math.random() * 1e9);
}

function readCookie(name) {
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? m.pop() : null;
}

/* envia o evento (beacon ou fetch) e GUARANTEIA espera fixa antes do redirect */
function sendEventThenRedirect(endpoint, json, url) {
  try {
    if (navigator.sendBeacon) {
      // sendBeacon Ã© a forma preferida
      navigator.sendBeacon(endpoint, new Blob([json], { type: 'application/json' }));
    } else {
      // fallback: fire-and-forget
      fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: json,
        keepalive: true
      }).catch(()=>{});
    }
  } catch (e) {
    // nÃ£o bloquear o fluxo por erro de envio
    console.warn('[collect] send error', e);
  }

  // espera fixa (UX previsÃ­vel) e redireciona
  setTimeout(() => {
    window.location.href = url;
  }, WAIT_MS);
}

function trackWhatsappClick(e, url) {
  e.preventDefault();
  if (locked) return;
  locked = true;

  // se jÃ¡ clicou nesta sessÃ£o, segue direto (previne duplicaÃ§Ã£o local)
  if (sessionStorage.getItem('group_join_sent')) {
    window.location.href = url;
    return;
  }

  // mostra o aviso (overlay estÃ¡tico)
  document.getElementById('loading')?.classList.remove('hidden');

  const eventId = generateEventId();
  sessionStorage.setItem('group_join_sent', eventId);

  const payload = JSON.stringify({
    event_name: 'GroupJoinIntent',
    event_id: eventId,
    event_source_url: window.location.href,
    fbp: readCookie('_fbp'),
    fbc: readCookie('_fbc'),
    custom_data: {
      destination: 'whatsapp_group',
      brand: 'Achadinho do Dia',
      button_text: 'ENTRAR NO GRUPO DE OFERTAS'
    }
  });

  // chama a Edge Function que faz o CAPI + contador
  sendEventThenRedirect('/.netlify/edge-functions/collect', payload, url);
}

document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('joinBtn');
  if (btn) {
    btn.addEventListener('click', function (ev) {
      trackWhatsappClick(ev, btn.href);
    }, { passive: false });
  }
});
</script>

</body>
</html>
