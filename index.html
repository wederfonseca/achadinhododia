<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Achadinho do Dia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1c1c1c">

  <link rel="icon" type="image/png" href="favicon-v6.png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <!-- META PIXEL â€” PageView -->
  <script>
    !function(f,b,e,v,n,t,s){
      if(f.fbq)return;
      n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;
      n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];
      t=b.createElement(e);t.async=!0;
      t.src=v;
      s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s);
    }(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');

    fbq('init', '777056694717675');
    fbq('track', 'PageView');
  </script>
</head>

<body>

<div class="page">
  <div class="top-bar">As melhores ofertas do dia, direto no seu WhatsApp</div>

  <div class="subtitle">
    Escolhemos diariamente o que faz sentido para vocÃª economizar.
  </div>

  <div class="image-box">
    <img src="caixa.png" alt="Ofertas do dia">
  </div>

  <div class="urgency">âš¡ Os melhores preÃ§os acabam rÃ¡pido</div>

  <a
    id="joinBtn"
    class="btn"
    href="https://busqy.me/grupos/achadinhododia"
    data-collect-endpoint="/collect"
  >
    ENTRAR NO GRUPO DE OFERTAS
  </a>

  <div class="checks">
    âœ… SÃ³ o que vale a pena<br>
    âœ… VocÃª pode sair quando quiser<br>
    âœ… PromoÃ§Ãµes exclusivas todos os dias
  </div>
</div>

<!-- OVERLAY -->
<div id="loading" class="loading hidden">
  <div class="loading-box">ðŸ”’ Reservando sua vaga no grupoâ€¦</div>
</div>

<script>
const WAIT_MS = 1000;
let locked = false;

function generateEventId() {
  if (crypto.randomUUID) return crypto.randomUUID();
  return 'evt_' + Date.now() + '_' + Math.random().toString(36).slice(2);
}

function readCookie(name) {
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? decodeURIComponent(m.pop()) : null;
}

function getExternalId() {
  const fbp = readCookie('_fbp');
  if (fbp) return fbp;
  return btoa(navigator.userAgent + Intl.DateTimeFormat().resolvedOptions().timeZone);
}

async function sendEventThenRedirect(endpoint, payload, url) {
  try {
    await fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-capi-signature': 'v1'
      },
      body: payload,
      keepalive: true
    });
  } catch (e) {
    console.warn('[collect] send error', e);
  }

  setTimeout(() => {
    window.location.href = url;
  }, WAIT_MS);
}

document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('joinBtn');
  if (!btn) return;

  btn.addEventListener('click', ev => {
    ev.preventDefault();
    if (locked) return;
    locked = true;

    if (sessionStorage.getItem('group_join_sent')) {
      window.location.href = btn.href;
      return;
    }

    document.getElementById('loading').classList.remove('hidden');

    const eventId = generateEventId();
    sessionStorage.setItem('group_join_sent', eventId);

    const payload = JSON.stringify({
      event_name: 'GroupJoinIntent',
      event_id: eventId,
      event_source_url: window.location.href,
      fbp: readCookie('_fbp'),
      fbc: readCookie('_fbc'),
      external_id: getExternalId(),
      custom_data: {
        destination: 'whatsapp_group',
        brand: 'Achadinho do Dia'
      }
    });

    sendEventThenRedirect(btn.dataset.collectEndpoint || '/collect', payload, btn.href);
  });
});
</script>

</body>
</html>
